commit 898399937a1afe937edba5137c51ffb4f7054056
Author: Leandro Pereira <leandro@hardinfo.org>
Date:   Tue Apr 30 08:22:51 2019 -0700

    Ensure detection of next request does not read past end of buffer
    
    Credit to OSS-Fuzz: https://bugs.chromium.org/p/oss-fuzz/issues/detail?id=14511

diff --git a/fuzz/clusterfuzz-testcase-minimized-request_fuzzer-5649134389821440 b/fuzz/clusterfuzz-testcase-minimized-request_fuzzer-5649134389821440
new file mode 100644
index 00000000..ffa011b3
--- /dev/null
+++ b/fuzz/clusterfuzz-testcase-minimized-request_fuzzer-5649134389821440
@@ -0,0 +1,3 @@
+GET /    ÿ                          ÿ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          &/T&R&/1.&T?&–?&–&T /&–&T /?& GE??&–?&–4T.& GE/?&–?&–&T & GE/?&–?&–&T /& /?&–&T&–?&y&T /&H?& /?&?& GE&–&RH?&/?&/TDR&HTTP/1.0l"l"
+
+i
\ No newline at end of file
diff --git a/src/lib/lwan-request.c b/src/lib/lwan-request.c
index 177e4a6a..0850edea 100644
--- a/src/lib/lwan-request.c
+++ b/src/lib/lwan-request.c
@@ -528,31 +528,31 @@ identify_http_path(struct lwan_request *request, char *buffer)
 static bool parse_headers(struct lwan_request_parser_helper *helper,
                           char *buffer)
 {
     char *buffer_end = helper->buffer->value + helper->buffer->len;
     char **header_start = helper->header_start;
     char *p;
     size_t n_headers = 0;
     bool ret = false;
 
     for (p = buffer + 1; n_headers < N_HEADER_START && buffer_end > p;) {
         char *next_chr = p;
         char *next_hdr = memchr(next_chr, '\r', (size_t)(buffer_end - p));
 
         if (!next_hdr)
             goto process;
 
-        if (next_chr == next_hdr) {
+        if (next_chr == next_hdr && buffer_end - next_chr > 2) {
             STRING_SWITCH_SMALL(next_hdr) {
             case MULTICHAR_CONSTANT_SMALL('\r', '\n'):
                 helper->next_request = next_hdr + 2;
             }
             goto process;
         }
 
         header_start[n_headers++] = next_chr;
         header_start[n_headers++] = next_hdr;
 
         p = next_hdr + 2;
     }
 
     goto out; /* Header array isn't large enough */
